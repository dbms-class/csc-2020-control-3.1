# Третья контрольная курса Базы Данных в CSC
Контрольная работа модуля №3. Вариант 1




### Инициализация БД
по умолчанию пользователь postgres с пустым паролем на localhost:5432/postgres

```
psql -h localhost -U postgres -f marsoflot.sql
```

### Запуск приложения
```
python3 app.py
```

Если нужно поменять хост, порт, пользователя, базу данных или пароль, воспользуйтесь аргументами командной строки. `python3 app.py -h`  вам про них расскажут.

### Как сдавать
Пул-реквест в репозиторий `github.com/dbms-class/csc-2020-control-3.1` или письмо с заархивированным кодом на `dmitry+csc@barashev.net`. Пожалуйста, не присылайте в архиве каталоги `build`, `.gradle` и `.idea` 

## Ошибки
1. В flight_cache используется менеджер контекста, в котором сессия не возвращается в пул.  
Правка: возвращаем коннекцию в пулл.

2. В flight_cache в цикле выполняется для каждого незакешированного полёта:  
`flight = FlightEntity.select().join(PlanetEntity).where(FlightEntity.id == flight_id).get()`
Что очень трудоемко если дата неуказана, поэтому в этом случае просто уберём пункт where, чтобы
получить всю таблицу полностью и заполнить ей кеш. Это операция будет выполняться на каждом запросе,
т.к. таблица может измениться.

Да и в целом слишком много запросов, кажется всех их можно сделать одной командой.
А именно, не для каждого полёта вытаскивать планету, а соединить сразу две таблицы и потом уже из них всё считать.
Сейчас вроде так и делается, join есть, но почему-то всё равно много запросов. 

3. В методе delete_planet вместо того чтобы вернуть соединение в пулл оно просто закрывается.
Решение: возвращаем коннекцию вместо закрытия.

4. Кеша в принципе не должно быть, т.к. при удалении планеты удалятся и полёты...
Временное решение: чистим кеш после каждого запроса.

5. В методе delete_planet курсор получаем вне блока try, если получить его не удастся, 
то приложение уберёт.
Решение: перенесём в блок трай. 

6. В методе delete_planet не подтверждается транзакция удаления планеты.
Добавим .commit()

7. В методе delay_flights не возвращается коннекция в пул.
Решение: вернём коннекцию.

8. В методе delay_flights не проверяется валидность интервала.

9. В методе delay_flights для каждого полёта отдельно обновляется его дата.
Решение: это можно сделать одним запросом.

10. В методе delay_flights нет подтверждения транзакции.
Решение: добавим.