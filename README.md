# Третья контрольная курса Базы Данных в CSC
Контрольная работа модуля №3. Вариант 1




### Инициализация БД
по умолчанию пользователь postgres с пустым паролем на localhost:5432/postgres

```
psql -h localhost -U postgres -f marsoflot.sql
```

### Запуск приложения
```
python3 app.py
```

Если нужно поменять хост, порт, пользователя, базу данных или пароль, воспользуйтесь аргументами командной строки. `python3 app.py -h`  вам про них расскажут.

### Как сдавать
Пул-реквест в репозиторий `github.com/dbms-class/csc-2020-control-3.1` или письмо с заархивированным кодом на `dmitry+csc@barashev.net`. Пожалуйста, не присылайте в архиве каталоги `build`, `.gradle` и `.idea` 

### Исправления

Принцип следующий - по номеру исправления в коде можно найти комментарий вида `# 1`, указывающий на исправленный код.

1. Соединения из пула на основе `with` утекают в `cache_flights`, `delay_flights`. Заменяем на `try/finally` с возвращением соединения методом `putconn`.
2. Нет проверки на ситуацию, когда нет полетов в дату, указанную входным параметром в `delay_flights`.
3. Атакуем сервер кучей запросов в `delay_flights`. Заменяем на запрос с `WHERE ... IN`.
4. Изменения в `delay_flights` и `delete_planet` не фиксируются, надо закоммитить.
5. Кэш полетов не очищается после модифицирующих запросов. 
6. Неведомый аргумент в `ForeignKeyField` для планет в `FlightEntity`. Заменяем на `backref`.
7. Нужно проверить, что удаляемая в `delete_planet` планета вообще существует.
8. Вместо ϴ(n) запросов в `cache_flights` делаем пару запросов с `WHERE ... IN` с помощью `prefetch`.